{% extends 'store/main.html' %}
{% block content %}
{% load store_tags %}
{% load widget_tweaks %}

    <!-- payhere API -->
    <script type="text/javascript" src="https://www.payhere.lk/lib/payhere.js"></script>

  <!-- Checkout form -->
  <div class="container" id="checkout">
    <div class="row mt-3">
        <!-- cart summary -->
        <div class="col-sm">
            <h4> Your Cart <span class="badge badge-warning cart-badge">3</span></h4>
            <ul class="list-group mb-3 z-depth-1">
                {% for item in data %}
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                      <h6 class="my-0">{{ item.name }}</h6>
                      <small class="text-muted module checkout-fades">{{ item.desc }}</small>
                    </div>
                    <span class="text-muted">{{ cart|get_cost:item.id }}</span>
                </li>
                {% endfor %}

                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                      <h6 class="my-0">Delivery</h6>
                      <small class="text-muted">Standard delivery cost</small>
                    </div>
                    <span class="text-muted">$5.00</span>
                </li>
                {% if coupon_detail.0 %}
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                      <h5 class="my-0">Sub Total (USD)</h5>
                    </div>
                    <span class="text-muted" >{{ cart|get_total:0 }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between lh-condensed">
                    <div>
                      <h6 class="my-0 text-success">Discount</h6>
                      <small class="text-muted">{{ coupon_detail.1 }}% off coupon</small>
                    </div>
                    <span class="text-success" >-{{ cart|get_coupon_discount:coupon_detail.1 }}</span>
                </li>
                {% endif %}
                <li class="list-group-item d-flex justify-content-between">
                    <h5 class="font-weight-bold">Total (USD)</h5>
                    <strong class="text-dark h6">{{ cart|get_total:coupon_detail.1 }}</strong>
                </li>
            </ul>
            <form class="card p-2" method="post">
                {% csrf_token %}
                <div class="input-group">
                  <input type="text" class="form-control" placeholder="Promo code" aria-label="promo_code" name="coupon_code" aria-describedby="basic-addon2">
                  <div class="input-group-append">
                    <button class="btn btn-secondary" type="submit" name="coupon_btn">Redeem</button>
                  </div>
                </div>
              </form>
        </div>
        <!-- checkout form -->
        <div class="col-sm-8 border rounded mt-2 mt-sm-0" id="checkoutForm">
            <h4 class="font-weight-bold">Delivery Details</h4>
            <form method="post">
                {% csrf_token %}
                <div class="form-group row">
                    <div class="col-sm-6">
                        <label>Address</label>
                        {% if delivery_form.address.errors %}
                          {% render_field delivery_form.address class="form-control is-invalid" %}
                          <div class="invalid-tooltip d-block float-right" data-placement="bottom">
                            {% for error in delivery_form.address.errors %}
                              {{ error }}
                            {% endfor %}
                          </div>
                        {% else %}
                          {% render_field delivery_form.address class="form-control" %}
                        {% endif %}
                    </div>
                        <div class="col-sm-6">
                            <label>City</label>
                            {% if delivery_form.city.errors %}
                              {% render_field delivery_form.city class="form-control is-invalid" %}
                              <div class="invalid-tooltip d-block float-right" data-placement="bottom">
                                {% for error in delivery_form.city.errors %}
                                  {{ error }}
                                {% endfor %}
                              </div>
                            {% else %}
                              {% render_field delivery_form.city class="form-control" %}
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6">
                            <label>State</label>
                            {% if delivery_form.state.errors %}
                              {% render_field delivery_form.state class="form-control is-invalid" %}
                              <div class="invalid-tooltip d-block float-right" data-placement="bottom">
                              {% for error in delivery_form.state.errors %}
                                {{ error }}
                              {% endfor %}
                               </div>
                            {% else %}
                              {% render_field delivery_form.state class="form-control" %}
                            {% endif %}
                        </div>
                        <div class="col-sm-3">
                            <label>Zip Code</label>
                            {% if delivery_form.zipcode.errors %}
                              {% render_field delivery_form.zipcode class="form-control is-invalid" %}
                              <div class="invalid-tooltip d-block float-right" data-placement="bottom">
                              {% for error in delivery_form.zipcode.errors %}
                                {{ error }}
                              {% endfor %}
                              </div>
                            {% else %}
                              {% render_field delivery_form.zipcode class="form-control" %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-sm-6">
                            <h6>Payment method</h6>
                            <div class="custom-control custom-radio">
                                <input id="payhere" name="paymentmethod" type="radio" class="custom-control-input" checked required>
                                <label class="custom-control-label" for="payhere">Payhere</label>
                            </div>
                            <div class="custom-control custom-radio">
                                <input id="cashondelivery" name="paymentmethod" type="radio" class="custom-control-input" required>
                                <label class="custom-control-label" for="cashondelivery">Cash On Delivery</label>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="col-sm-12 text-center">
                        <button type="submit" class="btn btn-success btn-block" name="checkout_btn">Complete Order</button>

                    </div>

                </form>
                <button type="submit" id="payhere-payment" >PayHere Pay</button>
            </div>
    </div>
  </div>
  <!-- END - checkout form -->
<!-- payhere integration -->
<script>
        // Called when user completed the payment. It can be a successful payment or failure
        payhere.onCompleted = function onCompleted(orderId) {
            console.log("Payment completed. OrderID:" + orderId);
            //Note: validate the payment and show success or failure page to the customer
        };

        // Called when user closes the payment without completing
        payhere.onDismissed = function onDismissed() {
            //Note: Prompt user to pay again or show an error page
            console.log("Payment dismissed");
        };

        // Called when error happens when initializing payment such as invalid parameters
        payhere.onError = function onError(error) {
            // Note: show an error page
            console.log("Error:"  + error);
        };

        // Put the payment variables here
        var payment = {
            "sandbox": true,
            "merchant_id": "1216558",    // Replace your Merchant ID
            "return_url": undefined,     // Important
            "cancel_url": undefined,     // Important
            "notify_url": "http://sample.com/notify",
            "order_id": "ItemNo12345",
            "items": "Door bell wireles",
            "amount": "1000.00",
            "currency": "LKR",
            "first_name": "Saman",
            "last_name": "Perera",
            "email": "samanp@gmail.com",
            "phone": "0771234567",
            "address": "No.1, Galle Road",
            "city": "Colombo",
            "country": "Sri Lanka",
            "delivery_address": "No. 46, Galle road, Kalutara South",
            "delivery_city": "Kalutara",
            "delivery_country": "Sri Lanka",
            "custom_1": "",
            "custom_2": ""
        };

        // Show the payhere.js popup, when "PayHere Pay" is clicked
        document.getElementById('payhere-payment').onclick = function (e) {
            payhere.startPayment(payment);
        };
    </script>

{% endblock content %}